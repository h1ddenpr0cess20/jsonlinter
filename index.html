<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSONLint Clone - Validator, Formatter, Minifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Core styles -->
  <style>
    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
      --success: #16a34a;
      --error: #dc2626;
      --btn: #0ea5e9;
      --btn-hover: #0284c7;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1220;
        --panel: #0f172a;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --border: #1e293b;
        --success: #22c55e;
        --error: #f87171;
        --btn: #38bdf8;
        --btn-hover: #0ea5e9;
      }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
    }
    header {
      position: sticky; top: 0; z-index: 20;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .brand {
      display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 18px;
    }
    .subtitle { display: block; font-weight: 500; color: var(--muted); font-size: 12px; }
    main .container { display: grid; gap: 16px; }
    .toolbar {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
      background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 8px;
    }
    .toolbar .spacer { flex: 1; }
    button, .file-label {
      appearance: none; border: 1px solid var(--border); background: var(--panel);
      color: var(--text); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;
    }
    button.primary {
      background: var(--btn); color: #fff; border-color: transparent;
    }
    button.primary:hover { background: var(--btn-hover); }
    button:hover, .file-label:hover { background: rgba(2,132,199,0.08); }
    .danger { color: var(--error); }
    .success { color: var(--success); }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 16px;
    }
    @media (min-width: 1200px) {
      .grid {
        grid-template-columns: minmax(700px, 1fr) 360px;
      }
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .panel-header {
      padding: 10px 12px; border-bottom: 1px solid var(--border); font-weight: 700;
    }
    #editor {
      height: 520px;
      border-top: 1px solid var(--border);
    }
    .panel-body { padding: 12px; }
    #status {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre-wrap;
    }
    .hint { color: var(--muted); font-size: 12px; }
    .drop-zone {
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
    }
    .kpis {
      display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;
    }
    .kpi {
      border: 1px solid var(--border); border-radius: 6px; padding: 6px 8px; background: var(--panel);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color: var(--muted);
      font-size: 12px;
    }
    .footer-note { margin-top: 8px; color: var(--muted); font-size: 12px; }
  /* JSON token colors for clearer highlighting */
  .cm-s-eclipse .cm-property { color: #1f6feb; }   /* keys */
  .cm-s-eclipse .cm-string { color: #22863a; }     /* string values */
  .cm-s-eclipse .cm-number { color: #6f42c1; }     /* numbers */
  .cm-s-eclipse .cm-atom { color: #d73a49; }       /* true/false/null */
  .cm-s-eclipse .cm-bracket { color: #8b949e; }    /* braces/brackets */
  </style>

  <!-- jsonlint: provides global `jsonlint` used by CodeMirror's json-lint addon -->
  <script src="https://cdn.jsdelivr.net/npm/jsonlint@1.6.3/web/jsonlint.js"></script>
  <script>
    // Ensure CodeMirror json-lint addon sees the global
    window.jsonlint = window.jsonlint || jsonlint;
  </script>

  <!-- CodeMirror core + JSON mode + linting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/json-lint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
</head>
<body>
  <header>
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div class="brand">
        <span aria-hidden="true" style="font-weight:800;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; font-size:20px;">{ }</span>
        <span>JSONLint Clone</span>
        <span class="subtitle">Validator • Formatter • Minifier</span>
      </div>
      <div class="hint">Client-side only • No data leaves your browser</div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="toolbar">
        <button class="primary" id="btnValidate">Validate</button>
        <button id="btnFormat">Format</button>
        <button id="btnMinify">Minify</button>
        <button id="btnSortKeys">Sort Keys</button>
        <div style="display:flex; align-items:center; gap:8px; margin-left:8px;">
          <label for="indentSelect" class="hint" style="font-size:12px;">Indent</label>
          <select id="indentSelect">
            <option value="2" selected>2</option>
            <option value="4">4</option>
            <option value="8">8</option>
          </select>
          <label class="hint" style="display:flex; align-items:center; gap:6px; font-size:12px;">
            <input type="checkbox" id="autoValidate" checked />
            Auto Validate
          </label>
        </div>
        <div class="spacer"></div>
        <label class="file-label">
          Load File
          <input id="fileInput" type="file" accept=".json,application/json" style="display:none" />
        </label>
        <button id="btnLoadUrl">Load URL</button>
        <button id="btnSample">Sample</button>
        <button id="btnCopy">Copy</button>
        <button id="btnClear">Clear</button>
        <button id="btnDownload">Download</button>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="panel-header">JSON Editor</div>
          <div id="editor" aria-label="JSON editor"></div>
          <div class="panel-body">
            <div class="drop-zone" id="dropZone">Drag & drop a .json file here</div>
            <div class="kpis">
              <div class="kpi" id="kpiSize">Size: 0 B</div>
              <div class="kpi" id="kpiLines">Lines: 0</div>
              <div class="kpi" id="kpiKeys">Keys: —</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">Status</div>
          <div class="panel-body">
            <div id="status" class="hint">Ready. Paste JSON, load a file/URL, or click Sample.</div>
            <div class="footer-note">Errors show with line/column and are highlighted in the editor.</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Setup CodeMirror
    const cm = CodeMirror(document.getElementById('editor'), {
      value: '{\n  "message": "Hello, JSONLint!"\n}',
      mode: { name: 'application/json', json: true },
      theme: 'eclipse',
      lineNumbers: true,
      lineWrapping: true,
      matchBrackets: true,
      gutters: ['CodeMirror-lint-markers'],
      lint: true,
      extraKeys: {
        'Ctrl-Enter': () => validate(),
        'Cmd-Enter': () => validate(),
        'Ctrl-B': () => formatJson(),
        'Cmd-B': () => formatJson(),
        'Ctrl-M': () => minifyJson(),
        'Cmd-M': () => minifyJson(),
        'Alt-S': () => sortKeys()
      }
    });
    cm.setSize('100%', 520);

    // Persist UI preferences
    const indentSelectEl = document.getElementById('indentSelect');
    const autoValidateEl = document.getElementById('autoValidate');
    try {
      const savedIndent = localStorage.getItem('jsonlint.indent');
      if (savedIndent && indentSelectEl) {
        indentSelectEl.value = savedIndent;
      }
      const savedAuto = localStorage.getItem('jsonlint.autoValidate');
      if (savedAuto !== null && autoValidateEl) {
        autoValidateEl.checked = savedAuto === 'true';
      }
      indentSelectEl?.addEventListener('change', (e) => {
        localStorage.setItem('jsonlint.indent', e.target.value);
      });
      autoValidateEl?.addEventListener('change', (e) => {
        localStorage.setItem('jsonlint.autoValidate', String(e.target.checked));
      });
    } catch {}

    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');

    const kpiSize = document.getElementById('kpiSize');
    const kpiLines = document.getElementById('kpiLines');
    const kpiKeys = document.getElementById('kpiKeys');

    function setStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.classList.remove('success', 'danger');
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'danger') statusEl.classList.add('danger');
    }

    function updateKpis() {
      const text = cm.getValue();
      kpiSize.textContent = 'Size: ' + new Blob([text]).size + ' B';
      kpiLines.textContent = 'Lines: ' + cm.lineCount();
      try {
        const obj = JSON.parse(text);
        const keys = Array.isArray(obj) ? obj.length : (typeof obj === 'object' && obj ? Object.keys(obj).length : 0);
        kpiKeys.textContent = 'Keys: ' + keys;
      } catch {
        kpiKeys.textContent = 'Keys: —';
      }
    }

    function scrollToError(line, ch) {
      cm.scrollIntoView({ line: line, ch: ch }, 100);
      cm.setCursor({ line: line, ch: ch });
      cm.focus();
    }

    function parseWithJsonlint(text) {
      // jsonlint.parse throws with message containing line/column
      try {
        const data = jsonlint.parse(text);
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: e.message || String(e) };
      }
    }

    function extractLineCol(errMsg) {
      // jsonlint error formats can vary:
      // "Parse error on line 3: ... Expecting 'STRING', got 'undefined'"
      // Try to find "line X" and "column Y"
      let line = null, col = null;
      const lineMatch = errMsg.match(/line\s+(\d+)/i);
      if (lineMatch) line = Number(lineMatch[1]) - 1;
      const colMatch = errMsg.match(/column\s+(\d+)/i);
      if (colMatch) col = Number(colMatch[1]) - 1;
      return { line, col };
    }

    function validate() {
      const text = cm.getValue().trim();
      if (!text) {
        setStatus('Please enter JSON.', 'danger');
        return false;
      }
      const res = parseWithJsonlint(text);
      if (res.ok) {
        setStatus('Valid JSON ✓', 'success');
        return true;
      } else {
        const { line, col } = extractLineCol(res.error);
        setStatus('Invalid JSON: ' + res.error, 'danger');
        if (line !== null) scrollToError(line, col || 0);
        return false;
      }
    }

    function formatJson() {
      const text = cm.getValue();
      const res = parseWithJsonlint(text);
      if (!res.ok) {
        validate();
        return;
      }
      const indent = parseInt(document.getElementById('indentSelect').value || '2', 10);
      const pretty = JSON.stringify(res.data, null, indent);
      cm.setValue(pretty);
      setStatus('Formatted with ' + indent + ' spaces.', 'success');
      updateKpis();
    }

    function minifyJson() {
      const text = cm.getValue();
      const res = parseWithJsonlint(text);
      if (!res.ok) {
        validate();
        return;
      }
      const minified = JSON.stringify(res.data);
      cm.setValue(minified);
      setStatus('Minified JSON.', 'success');
      updateKpis();
    }

    function sortKeysDeep(value) {
      if (Array.isArray(value)) {
        return value.map(sortKeysDeep);
      } else if (value && typeof value === 'object') {
        const sorted = {};
        Object.keys(value).sort((a, b) => a.localeCompare(b)).forEach(k => {
          sorted[k] = sortKeysDeep(value[k]);
        });
        return sorted;
      }
      return value;
    }

    function sortKeys() {
      const text = cm.getValue();
      const res = parseWithJsonlint(text);
      if (!res.ok) {
        validate();
        return;
      }
      const sorted = sortKeysDeep(res.data);
      cm.setValue(JSON.stringify(sorted, null, 2));
      setStatus('Sorted keys recursively.', 'success');
      updateKpis();
    }

    function copyToClipboard() {
      const text = cm.getValue();
      navigator.clipboard.writeText(text).then(() => {
        setStatus('Copied to clipboard.', 'success');
      }).catch(() => {
        setStatus('Unable to copy to clipboard.', 'danger');
      });
    }

    function clearEditor() {
      cm.setValue('');
      setStatus('Cleared.', null);
      updateKpis();
    }

    function sample() {
      const example = {
        name: "JSONLint",
        url: "https://jsonlint.com/",
        features: ["validate", "format", "minify", "lint"],
        nested: { a: 1, b: true, c: null }
      };
      cm.setValue(JSON.stringify(example, null, 2));
      setStatus('Loaded sample JSON.', 'success');
      updateKpis();
      cm.focus();
    }

    function download() {
      const text = cm.getValue();
      const blob = new Blob([text], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'data.json';
      a.click();
      URL.revokeObjectURL(url);
      setStatus('Downloaded data.json', 'success');
    }

    async function loadUrl() {
      const url = prompt('Enter a JSON URL (https://...)');
      if (!url) return;
      setStatus('Fetching ' + url + ' ...');
      try {
        const resp = await fetch(url, { headers: { 'Accept': 'application/json,*/*;q=0.9' } });
        if (!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
        const contentType = resp.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          const obj = await resp.json();
          cm.setValue(JSON.stringify(obj, null, 2));
          setStatus('Loaded and formatted JSON from URL.', 'success');
        } else {
          const text = await resp.text();
          try {
            const obj = JSON.parse(text);
            cm.setValue(JSON.stringify(obj, null, 2));
            setStatus('Loaded and formatted JSON from URL.', 'success');
          } catch {
            cm.setValue(text);
            setStatus('Loaded response (not strictly valid JSON).', 'danger');
          }
        }
        updateKpis();
      } catch (e) {
        setStatus('Failed to fetch: ' + (e.message || e), 'danger');
      }
    }

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        cm.setValue(String(reader.result));
        setStatus('Loaded file: ' + file.name, 'success');
        updateKpis();
      };
      reader.onerror = () => setStatus('Failed to read file.', 'danger');
      reader.readAsText(file);
    }

    // Events: toolbar
    document.getElementById('btnValidate').addEventListener('click', validate);
    document.getElementById('btnFormat').addEventListener('click', formatJson);
    document.getElementById('btnMinify').addEventListener('click', minifyJson);
    document.getElementById('btnSortKeys').addEventListener('click', sortKeys);
    document.getElementById('btnCopy').addEventListener('click', copyToClipboard);
    document.getElementById('btnClear').addEventListener('click', clearEditor);
    document.getElementById('btnSample').addEventListener('click', sample);
    document.getElementById('btnDownload').addEventListener('click', download);
    document.getElementById('btnLoadUrl').addEventListener('click', loadUrl);

    // File input
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) handleFile(file);
      e.target.value = '';
    });

    // Drag & drop
    ;['dragenter','dragover'].forEach(evt =>
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropZone.style.background = 'rgba(2,132,199,0.08)';
      })
    );
    ;['dragleave','drop'].forEach(evt =>
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropZone.style.background = '';
      })
    );
    dropZone.addEventListener('drop', (e) => {
      const file = e.dataTransfer?.files?.[0];
      if (file) handleFile(file);
    });

    // Auto-validate (debounced) and KPIs update
    let t;
    cm.on('change', () => {
      updateKpis();
      clearTimeout(t);
      t = setTimeout(() => {
        const auto = document.getElementById('autoValidate').checked;
        if (auto) {
          const ok = validate();
          if (ok) setStatus('Looks good ✓', 'success');
        }
      }, 400);
    });

    // Initial KPIs
    updateKpis();
  </script>
</body>
</html>
